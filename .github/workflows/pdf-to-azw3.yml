name: PDF to AZW3 (Kindle Optimized)

on:
  push:
    paths:
      - "input/*.pdf"

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xdg-utils libegl1 libopengl0 poppler-utils

      - name: Install Calibre
        run: |
          wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sudo sh /dev/stdin

      - name: Convert PDFs to AZW3
        run: |
          mkdir -p output
          for file in input/*.pdf; do
            name=$(basename "$file" .pdf)
            ebook-convert "$file" "output/$name.azw3" \
              --pdf-engine=pdftohtml \
              --no-images \
              --remove-paragraph-spacing \
              --remove-paragraph-spacing-indent-size=1.0 \
              --chapter "//*[name()='h1' or name()='h2']" \
              --linearize-tables \
              --disable-font-rescaling
          done

      - name: Upload AZW3 files
        uses: actions/upload-artifact@v4
        with:
          name: azw3-output
          path: output/
